# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
This guidance is aimed at Claude Code but may as well be suitable for other AI tooling, such as GitHub Copilot.

Instructions for an LLM (such as Claude) working with the code:

- Take these instructions in mind
- Look at existing code, type hints, docstrings and comments
- Propose changes to extend this document with new learnings

## Project Overview

`deezer-python-gql` is an async typed Python client for Deezer's **Pipe GraphQL API** (`pipe.deezer.com/api`). It is a standalone library designed to be consumed by [Music Assistant](https://github.com/music-assistant/server)'s Deezer provider, replacing the official `deezer-python` REST wrapper with a type-safe GraphQL client.

All client methods and response models are **generated** from the GraphQL schema and `.graphql` query files using [ariadne-codegen](https://github.com/mirumee/ariadne-codegen). The only hand-written code is the base client (auth), the schema conversion script, and tests.

## Development Commands

### Setup and Dependencies

- `make setup` — Install all dependencies (runtime + test + dev/codegen) and configure pre-commit hooks
- Uses **uv** as the package manager (not pip directly)
- Always re-run `make setup` after pulling latest code

### Code Generation

- `make generate` — Fetch live schema from `pipe.deezer.com`, convert to SDL, run ariadne-codegen (full pipeline)
- `make codegen` — Convert existing `schema.json` to SDL and run ariadne-codegen (no live fetch, faster)
- `make fetch-schema` — Only fetch introspection JSON from the live API (no auth required)
- `make clean-generated` — Delete all generated code (`deezer_python_gql/generated/`)

### Exploring the API

- `uv run python scripts/explore.py queries/get_me.graphql` — Run a `.graphql` file against the live API
- `uv run python scripts/explore.py -q '{ me { id } }'` — Run an inline query
- `uv run python scripts/explore.py -q '...' -v '{"id": "123"}'` — Pass variables as JSON
- `make explore Q=queries/get_me.graphql` — Shorthand via Make
- Requires a `.env` file with `DEEZER_ARL=your_arl_value` (`.env` is gitignored)
- Handles JWT auth automatically via `DeezerBaseClient`

### Testing and Quality

- `make test` or `uv run pytest` — Run all tests (pytest with coverage enabled by default)
- `make lint` or `uv run pre-commit run --all-files` — Run all linters and type checks
- `uv run pytest tests/test_client.py` — Run a specific test file
- `uv run mypy` — Type check only
- `uv run ruff check .` — Lint only
- `uv run ruff format --check .` — Format check only

Always run `make lint` after a code change to ensure the new code adheres to the project standards.

### Pre-commit Hooks (in order)

1. `ruff format` — Code formatting
2. `ruff check --fix` — Linting with auto-fix
3. `codespell` — Spell checking (skips `*.json`, `schema.graphql`)
4. `check-ast` — Python AST validation
5. `check-json` — JSON validation (excludes `schema.json`)
6. `check-toml` — TOML validation
7. `mypy` — Strict type checking

## Architecture

### Directory Structure

```
deezer-python-gql/
├── deezer_python_gql/           # Package source
│   ├── __init__.py              # Public API — exports DeezerGQLClient
│   ├── base_client.py           # Hand-written: ARL→JWT auth, execute(), get_data()
│   ├── py.typed                 # PEP 561 marker for type checkers
│   └── generated/               # AUTO-GENERATED by ariadne-codegen — never edit manually
│       ├── __init__.py
│       ├── base_client.py       # Generated copy of base client (codegen artifact)
│       ├── base_model.py        # Pydantic base model configuration
│       ├── client.py            # DeezerGQLClient with typed methods (one per .graphql query)
│       ├── enums.py             # GraphQL enum types used by queries
│       ├── input_types.py       # GraphQL input types used by mutations
│       ├── get_me.py            # Response models for GetMe query
│       ├── get_track.py         # Response models for GetTrack query
│       ├── get_album.py         # Response models for GetAlbum query
│       ├── get_artist.py        # Response models for GetArtist query
│       ├── get_playlist.py      # Response models for GetPlaylist query
│       └── search.py            # Response models for Search query
├── queries/                     # GraphQL query/mutation documents (.graphql files)
│   ├── get_me.graphql           # GetMe: current authenticated user
│   ├── get_track.graphql        # GetTrack: full track details with media/lyrics
│   ├── get_album.graphql        # GetAlbum: album details with paginated tracks
│   ├── get_artist.graphql       # GetArtist: artist with top tracks and albums
│   ├── get_playlist.graphql     # GetPlaylist: playlist with paginated tracks
│   └── search.graphql           # Search: unified search across entity types
├── schema.graphql               # Full SDL schema (16,235 lines, ~915 types) — generated
├── schema.json                  # Raw introspection JSON — generated
├── scripts/
│   ├── convert_schema.py        # Fetch introspection + fix broken types + convert to SDL
│   └── explore.py               # Ad-hoc query runner for development (reads ARL from .env)
├── tests/
│   ├── test_client.py           # Unit tests: client setup, model parsing from fixtures
│   └── fixtures/                # Recorded API responses (sanitized, never from live calls)
│       ├── get_me.json
│       ├── get_track.json
│       ├── get_album.json
│       ├── get_artist.json
│       ├── get_playlist.json
│       └── search.json
├── pyproject.toml               # Project config (dependencies, ruff, mypy, pytest, codegen)
├── Makefile                     # Dev commands
├── .pre-commit-config.yaml      # Local hooks (no remote repos)
└── .github/workflows/           # CI: test.yml, publish-to-pypi.yml, release-drafter.yml
```

### Code Generation Pipeline

```
pipe.deezer.com/api   →   schema.json   →   schema.graphql   →   deezer_python_gql/generated/
  (introspection)       (raw JSON)          (SDL, fixed)          (typed client + models)
       ↑                     ↑                    ↑                        ↑
  fetch_introspection   fix_introspection    convert_to_sdl         ariadne-codegen
  (scripts/convert_schema.py)                                     (reads queries/*.graphql)
```

1. **Introspection** (no auth): `scripts/convert_schema.py --fetch` sends the standard introspection query to `pipe.deezer.com/api`. No authentication required.
2. **Fix**: Patches broken introspection results — missing `possibleTypes` on unions, missing `interfaces` on objects, truncated `NON_NULL`/`LIST` type wrappers.
3. **SDL conversion**: Uses `graphql-core`'s `build_client_schema` + `print_schema` to produce clean SDL.
4. **Codegen**: ariadne-codegen reads `schema.graphql` + all `queries/*.graphql` files and generates the typed async client class with Pydantic response models.

### Adding a New Query

1. Create a `.graphql` file in `queries/` (e.g., `queries/get_user_favorites.graphql`)
2. Define the query using types from `schema.graphql`
3. Run `make codegen` (or `make generate` for a fresh schema)
4. ariadne-codegen produces:
   - A new method on `DeezerGQLClient` (e.g., `get_user_favorites()`)
   - A new response model file in `generated/` (e.g., `get_user_favorites.py`)
5. Add tests in `tests/`

### Adding a New Mutation

Same as queries — create a `.graphql` file with a `mutation` operation, run `make codegen`.

### Authentication Flow

```
ARL cookie → POST auth.deezer.com/login/arl?jo=p&rto=c&i=c → JWT (6 min TTL)
                                                                     ↓
                                                            Bearer token in
                                                            Authorization header
                                                                     ↓
                                                            POST pipe.deezer.com/api
```

- The ARL cookie must be set on the `auth.deezer.com` domain (not `www.deezer.com`)
- Response is `Content-Type: text/plain` containing JSON — parse with `json.loads(resp.text)`, not `resp.json()`
- JWT expiration is decoded from the token payload (base64url-encoded second segment)
- Auto-refresh triggers 30 seconds before expiry

## Key Configuration

- **Python**: 3.12+ required (tested on 3.12, 3.13)
- **Runtime dependencies**: `httpx>=0.27.0`, `pydantic>=2.0.0` — intentionally minimal
- **Dev dependencies** (extras `[dev]`): `ariadne-codegen[subscriptions]` — only needed for code generation
- **Test dependencies** (extras `[test]`): ruff, mypy, pytest, pytest-asyncio, pytest-cov, codespell, pre-commit
- **Package manager**: uv (not pip)
- **Build system**: setuptools (declared in pyproject.toml)

### ariadne-codegen Configuration (in pyproject.toml)

| Setting                 | Value                              | Purpose                                       |
| ----------------------- | ---------------------------------- | --------------------------------------------- |
| `schema_path`           | `schema.graphql`                   | SDL schema input                              |
| `queries_path`          | `queries`                          | Directory of `.graphql` query files           |
| `target_package_name`   | `generated`                        | Output package name                           |
| `target_package_path`   | `deezer_python_gql`                | Output parent directory                       |
| `client_name`           | `DeezerGQLClient`                  | Generated client class name                   |
| `base_client_name`      | `DeezerBaseClient`                 | Custom base client class name                 |
| `base_client_file_path` | `deezer_python_gql/base_client.py` | Custom base client file                       |
| `async_client`          | `true`                             | Generate async methods                        |
| `include_all_inputs`    | `false`                            | Only generate inputs used by queries          |
| `include_all_enums`     | `false`                            | Only generate enums used by queries           |
| `plugins`               | `ShorterResultsPlugin`             | Unwrap single-field responses for cleaner API |

## Code Style Guidelines

### General Rules

- **ruff** handles all formatting and linting (config in `pyproject.toml`, `select = ["ALL"]` with targeted ignores)
- Line length: 100 characters
- Target: Python 3.12
- `deezer_python_gql/generated` and `scripts/` are excluded from ruff

### Never Edit Generated Code

The `deezer_python_gql/generated/` directory is entirely auto-generated by ariadne-codegen. **Never edit files in this directory manually.** To change the generated output:

- Modify the `.graphql` query files in `queries/`
- Or modify `base_client.py` (which codegen copies into `generated/`)
- Then run `make codegen`

### Docstring Format

Uses **Sphinx-style docstrings** consistent with Music Assistant:

```python
def my_function(param1: str, param2: int) -> str:
    """Brief one-line description.

    Optional longer description.

    :param param1: Description of param1.
    :param param2: Description of param2.
    """
```

For simple functions, a single-line docstring is sufficient:

```python
def get_item(self, item_id: str) -> Item:
    """Get an item by its ID."""
```

### Comments

Use comments only to explain "why", not "what". Reserve inline comments for complex multi-line blocks.

### Type Hints

- All functions must have complete type annotations (enforced by mypy strict mode)
- Use `from __future__ import annotations` for modern syntax in all files
- Prefer `X | None` over `Optional[X]`
- Use `cast()` sparingly and only when the type system genuinely can't infer

## Testing

- Tests are in `tests/`
- Framework: pytest with pytest-asyncio (`asyncio_mode = "auto"`)
- Coverage: enabled by default via `addopts = "--cov deezer_python_gql"` in pyproject.toml
- **No live API calls** — all tests use mocked HTTP or recorded JSON fixtures

### Test Structure

Tests are organized into four layers:

| Layer                  | Tests | What's validated                                                                   |
| ---------------------- | ----- | ---------------------------------------------------------------------------------- |
| **Client setup**       | 3     | Import, instantiation with ARL, presence of all 6 generated methods                |
| **Auth flow** (mocked) | 5     | JWT acquisition, token reuse, refresh on expiry, cookie domain, text/plain parsing |
| **Error handling**     | 5     | HTTP errors, invalid JSON, missing data key, GraphQL errors, success path          |
| **Model smoke tests**  | 6     | One per query — fixture parses correctly with key fields accessible                |

### Auth Flow Tests

Auth tests mock `httpx.AsyncClient` to verify the hand-written `DeezerBaseClient` logic:

- JWT is acquired from `auth.deezer.com/login/arl` on first request
- Valid JWT is reused without re-auth
- Expiring JWT (within 30s margin) triggers refresh
- ARL cookie is sent to the correct domain (`auth.deezer.com`, not `www.deezer.com`)
- `text/plain` response body is correctly parsed as JSON

### Error Handling Tests

Error tests call `get_data()` directly with crafted `httpx.Response` objects:

- `GraphQLClientHttpError` for non-2xx status codes
- `GraphQLClientInvalidResponseError` for non-JSON or structurally invalid responses
- `GraphQLClientGraphQLMultiError` for GraphQL-level errors with message/location/path

### Model Smoke Tests

One test per query verifying the recorded JSON fixture parses through the generated Pydantic models. These catch regressions when re-running codegen after schema changes.

Fixtures live in `tests/fixtures/` — recorded from the live API, then sanitized (user IDs, media tokens).

### Fixture Requirements

Fixtures must include `__typename` fields for discriminated union types:

- `"__typename": "Artist"` on all `Contributor` union nodes
- `"__typename": "Url"` on all `DeezerUrl` interface nodes

The `explore.py` script does **not** add `__typename` automatically — patch fixtures manually or with a script after recording.

### Test Naming Convention

```python
def test_<what_is_being_tested>() -> None:
    """Describe the expected behavior."""
```

## CI/CD

### Commit Messages

Use [Conventional Commits](https://www.conventionalcommits.org/) format:

```
<type>: <short summary>

<optional body>
```

Common types: `feat`, `fix`, `docs`, `chore`, `refactor`, `test`, `ci`.

Release Drafter uses these prefixes to categorize changelog entries automatically.

### Workflows

| Workflow              | Trigger                       | Purpose                                                     |
| --------------------- | ----------------------------- | ----------------------------------------------------------- |
| `test.yml`            | Push to `main`, PRs to `main` | Lint + type check + test on Python 3.12 & 3.13              |
| `publish-to-pypi.yml` | GitHub Release published      | Build and publish to PyPI via `pypa/gh-action-pypi-publish` |
| `release-drafter.yml` | PRs merged to `main`          | Auto-draft release notes                                    |

### Branching

- **`main`** — single development branch, all PRs target this
- No `dev`/`stable` split (simple library, not a server)

## Deezer Pipe API Reference

### Key Facts

- **Endpoint**: `https://pipe.deezer.com/api` (POST, standard GraphQL)
- **Introspection**: Enabled without auth (~915 types, 16,235 lines SDL)
- **Auth**: ARL → JWT Bearer token (6 min TTL, auto-refresh)
- **Rate limiting**: Not documented; GraphQL naturally batches, reducing request volume
- **Schema stability**: Undocumented, unofficial API — may change without notice

### Commonly Used Types

| Type          | Key Fields                                                                                                                                                            |
| ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Track`       | `id`, `title`, `ISRC`, `diskInfo`, `duration`, `album`, `contributors`, `lyrics`, `media` (token + sizes), `isFavorite`, `recommendedTracks`, `isAtmos`, `isExplicit` |
| `Album`       | `id`, `displayTitle`, `type`, `cover`, `label`, `contributors`, `releaseDate`, `tracks`, `isFavorite`, `fallback`                                                     |
| `Artist`      | `id`, `name`, `bio`, `picture`, `albums(types, roles)`, `topTracks`, `relatedArtist`, `isFavorite`                                                                    |
| `Playlist`    | `id`, `title`, `description`, `picture`, `tracks(first, after, order)`, `rawTracks`, `owner`, `isFavorite`                                                            |
| `Livestream`  | `id`, `name`, `language`, `description`, `cover`, `country`, `media: [ExternalMedia!]!`                                                                               |
| `Lyrics`      | `synchronizedLines`, `synchronizedWordByWordLines`, `text`, `copyright`, `writers`                                                                                    |
| `FlowConfig`  | `id`, `title`, `visuals`, `tracks: [FlowConfigTrack!]!`                                                                                                               |
| `TrackMedia`  | `id`, `version`, `token`, `estimatedSizes`, `rights: MediaRights!`                                                                                                    |
| `Search`      | `results.{tracks, artists, albums, playlists, podcasts, livestreams}`, `topResult`, `mixedResults`                                                                    |
| `PrivateUser` | `id`, `playlists`, `userFavorites`, `flow`, `flowConfigs`, `recommendations`, `madeForMe`, `recentlyPlayed`, `charts`                                                 |

### Key Mutations

- **Favorites**: `add/remove{Album,Artist,Track,Playlist,Podcast}ToFavorite`/`FromFavorite`
- **Playlists**: `createPlaylist`, `updatePlaylist`, `deletePlaylist`, `addTracksToPlaylist`, `removeTracksFromPlaylist`
- **Not available**: No listen logging mutation (`log.listen` only exists in GW API)

### Auth Gotchas

1. ARL cookie domain must be `auth.deezer.com`, not `www.deezer.com`
2. Auth response is `Content-Type: text/plain` — use `json.loads(resp.text)`
3. Endpoint is `login/arl`, not `login/renew` (which requires OAuth refresh token)
4. JWT TTL is 360 seconds — refresh proactively (30s margin implemented in base client)

### Schema Quirks

The live introspection result has known issues that `scripts/convert_schema.py` auto-fixes:

- Union types may have empty `possibleTypes`
- Object types may be missing `interfaces` field
- `NON_NULL`/`LIST` type wrappers may be truncated (missing `ofType`)
- These are fixed during the JSON→SDL conversion step
